# 会话总结：uCOS2/uCOS3 CMSIS-RTOS2 兼容层对齐与静态消息队列

- **日期**：2025-12-13
- **分支**：`cursor/ucos3-interface-compatibility-check-6be2`

## 1. 子模块版本基线（后续讨论默认以此为准）

- `libs/uC-OS3`: `93d6e79023f1031480c20f479ca7662f3f1c3c3a`（v3.08.02 系列）
- `libs/uC-OS2`: `0c4a48e6fbc6e915714e816196619a5481accf0c`（`v2.93.01`，即 2.93.1 系列）

## 2. uCOS3 兼容层对齐要点

- 对齐 `libs/uC-OS3 v3.08.02` 的缺失符号/签名差异（例如 `OSTimeGet(&err)` 形态、`OSTmrSet` 形态、若干枚举/状态类型差异等）。
- 文档已同步：`CMSIS/RTOS2/uCOS3/{README-uCOS3.md,PORTING.md,SUPPORT.md}`。

## 3. uCOS2 兼容层对齐要点

- 子模块 `v2.93.01` 中让出接口是 `OS_Sched()`（不是 `OSSched()`）。
- 修复了头文件声明为外部函数但源文件写成 `static` 的冲突（`osUcos2*FromId` 一组）。

## 4. uCOS3 MessageQueue 设计决策（重要）

目标：支持 **任意 msg_size**，并且 **强制静态队列**（不依赖 uC/OS-III 全局消息池）。

- **当前约束**：无论 `msg_size` 是否等于 `sizeof(void*)`，`osMessageQueueNew()` 都要求提供 `attr->mq_mem`。
- **实现方式**：
  - `mq_mem` 作为消息块存储区（至少 `msg_count * msg_size`）；
  - 内部 `OS_Q` 只传递“消息块指针”；
  - `Put/Get` 对用户消息做 `memcpy`；
  - free-list（空闲块指针栈）存放在 `cb_mem` 的额外空间里（因此 `cb_size` 需大于 `sizeof(os_ucos3_message_queue_t)`）。
- **示例已更新**：`CMSIS/RTOS2/uCOS3/examples/basic/main.c`

## 5. 在线测试/自检方式（仅语法/接口层）

仓库新增了轻量编译检查：

- **脚本**：`ci/compile-check/syntax-check.sh`
- **作用**：通过 stub 配置做 `-fsyntax-only` 编译，验证 uCOS2/uCOS3 兼容层能与当前子模块头文件“对齐编译”。
- **运行**：
  - `ci/compile-check/syntax-check.sh`

> 说明：该检查不等价于目标工程的真实 BSP/端口集成编译或运行测试，仅用于接口/语法层回归。

## 6. 关键提交（按时间倒序）

- `3a52b23`：强制 uCOS3 MessageQueue 必须提供 `mq_mem`（完全静态、自带存储）。
- `61d3cb7`：uCOS3 MessageQueue 支持任意 msg_size（最初版本仍保留指针兼容模式）。
- `dfd013f`：新增语法编译检查脚本与 stubs，并修复编译过程中发现的问题。
- `29ffd9d`：uCOS2 yield 对齐为 `OS_Sched()` 并同步文档。
- `9816ca8`：`libs/uC-OS2` 固定到 `v2.93.01`。
- `9de5959` / `7c5959e`：uCOS3 对齐 v3.08.02 + 文档同步。
- `4794abc`：输出 uCOS3 接口不一致问题报告（见 `开发记录/2025-12-13_uCOS3-CMSIS-OS2-接口一致性检查_问题报告.md`）。
